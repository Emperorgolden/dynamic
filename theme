#!/bin/bash
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

clear
echo -e "${CYAN}=============================================="
echo -e " Golden Hosting Enterprise dynamic theme deployer."
echo -e "==============================================${NC}"
echo

if ! command -v ffmpeg &> /dev/null; then
    echo -e "${YELLOW}雪  ffmpeg is not installed.${NC}"
    read -p "Install now? (y/N): " install_ffmpeg
    if [[ "$install_ffmpeg" =~ ^[Yy]$ ]]; then
        [[ $EUID -ne 0 ]] && SUDO_CMD="sudo" || SUDO_CMD=""
        $SUDO_CMD apt-get update -y
        $SUDO_CMD apt-get install -y ffmpeg
        echo -e "${GREEN}雪 ffmpeg installed.${NC}"
    else
        echo -e "${RED}雪 Operation cancelled.${NC}"
        exit 1
    fi
fi

WRAPPER="/var/www/pterodactyl/resources/views/templates/wrapper.blade.php"
BACKUP="$WRAPPER.bak"
MEDIA_DIR="/var/www/pterodactyl/public/assets/media"
CSS_DIR="/var/www/pterodactyl/public/assets/css"
mkdir -p "$MEDIA_DIR" "$CSS_DIR"
[[ ! -f "$BACKUP" ]] && cp "$WRAPPER" "$BACKUP"

read -p "Paste direct media (image/video) URL for background: " media_url
[[ -z "$media_url" ]] && { echo -e "${RED}[ERROR] No URL provided.${NC}"; exit 1; }

file_extension="${media_url##*.}"
media_type="unknown"
case "$file_extension" in
    jpg|jpeg|png|gif) media_type="image" ;;
    mp4|webm|mov) media_type="video" ;;
    *) echo -e "${RED}[ERROR] Unsupported file type.${NC}"; exit 1 ;;
esac

ORIGINAL_FILE="$MEDIA_DIR/original.$file_extension"
FINAL_FILE="$MEDIA_DIR/custom_bg.webm"

echo -e "${CYAN}Downloading media...${NC}"
wget -q --show-progress "$media_url" -O "$ORIGINAL_FILE"

if [[ "$media_type" == "video" ]]; then
    echo -e "${CYAN}Converting video to 1080p WebM...${NC}"
    ffmpeg -i "$ORIGINAL_FILE" -vf "scale=-1:1080" -c:v libvpx-vp9 -crf 23 -b:v 0 -row-mt 1 -threads 4 -deadline good -an -y "$FINAL_FILE"
    rm -f "$ORIGINAL_FILE"
    saved_filename="custom_bg.webm"
    file_extension="webm"
else
    mv "$ORIGINAL_FILE" "$MEDIA_DIR/custom_bg.$file_extension"
    saved_filename="custom_bg.$file_extension"
fi

CSS_FILE="$CSS_DIR/custom-background.css"
if [[ "$media_type" == "image" ]]; then
cat <<EOF > "$CSS_FILE"
body {
    background: url('/assets/media/$saved_filename') no-repeat center center fixed !important;
    background-size: cover !important;
}
EOF
else
cat <<EOF > "$CSS_FILE"
#dynamic-background-video {
    position: fixed;
    right: 0;
    bottom: 0;
    min-width: 100%;
    min-height: 100%;
    z-index: -10;
    object-fit: cover;
}
body {
    background-color: #000 !important;
}
EOF
fi

LOGIN_CSS="$CSS_DIR/login-theme.css"
cat <<'EOF' > "$LOGIN_CSS"
.login-panel, body[class*="LoginPageContainer"] .pt-8 > .w-full {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
}
form[action$="/login"] {
    position: relative;
    background: transparent !important;
    padding: 2.5rem;
    overflow: hidden;
    border-radius: 1rem;
}
form[action$="/login"]::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: -1;
    background: rgba(35, 35, 45, 0.65);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}
form[action$="/login"] img {
    display: block;
    margin-left: auto;
    margin-right: auto;
    margin-bottom: 1.5rem;
}
form[action$="/login"] label {
    color: #e0e0e0 !important;
}
form[action$="/login"] input[type=email], form[action$="/login"] input[type=text], form[action$="/login"] input[type=password] {
    background: rgba(0, 0, 0, 0.25) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    color: #FFFFFF !important;
}
form[action$="/login"] button[type=submit] {
    background: #0d6efd !important;
    color: white !important;
    transition: background 0.2s ease !important;
}
form[action$="/login"] button[type=submit]:hover {
    background: #0b5ed7 !important;
}
form[action$="/login"] a {
    color: #c0c0c0 !important;
    text-align: center;
    display: block;
    margin-top: 1rem;
}
form[action$="/login"] a:hover {
    color: #FFFFFF !important;
}
EOF

inject_wrapper() {
    grep -q "custom-background.css" "$WRAPPER" || sed -i "//i\        <link rel='stylesheet' href='/assets/css/custom-background.css'>" "$WRAPPER"
    grep -q "login-theme.css" "$WRAPPER" || sed -i "//i\        <link rel='stylesheet' href='/assets/css/login-theme.css'>" "$WRAPPER"

    if [[ "$media_type" == "video" ]]; then
        VIDEO_TAG="<video autoplay muted loop id='dynamic-background-video' style='position:fixed;top:0;left:0;width:100%;height:100%;z-index:-10;object-fit:cover;'><source src='/assets/media/$saved_filename' type='video/webm'></video>"
        sed -i '/id="dynamic-background-video"/d' "$WRAPPER"
        sed -i "/<body /a\\
$VIDEO_TAG
" "$WRAPPER"
    fi

    FOOTER_HTML="All rights reserved by Golden Hosting Enterprise © 2025"
    grep -q "Golden Hosting Enterprise" "$WRAPPER" || sed -i "/@yield('below-container')/a\        $FOOTER_HTML" "$WRAPPER"
}

inject_wrapper

cd /var/www/pterodactyl
php artisan view:clear
php artisan config:clear
php artisan cache:clear
php artisan queue:restart
systemctl restart nginx

echo -e "${GREEN}雪 Theme deployment complete.${NC}"
