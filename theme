#!/bin/bash
set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Safer log location (works even when not root)
LOG_FILE="/var/www/pterodactyl/storage/logs/ghe-theme-deployer.log"

# --- Logging helpers ---
log()  { echo -e "${CYAN}[INFO]${NC}  $*"; }
warn() { echo -e "${YELLOW}[WARN]${NC}  $*"; }
err()  { echo -e "${RED}[ERROR]${NC} $*"; }

# Log everything to console + file
mkdir -p "$(dirname "$LOG_FILE")" || true
exec > >(tee -a "$LOG_FILE") 2>&1

# Show a helpful error if anything fails
trap 'err "Script failed at line $LINENO. Check log: $LOG_FILE"' ERR

clear
echo -e "${CYAN}=============================================="
echo -e " Golden Hosting Enterprise - Theme Deployer v2"
echo -e "==============================================${NC}"
echo
log "Logging to: $LOG_FILE"

# --- Dependencies ---
if ! command -v ffmpeg &> /dev/null; then
  warn "ffmpeg is not installed."
  read -p "Do you want to install it now? (y/N): " install_ffmpeg
  if [[ "${install_ffmpeg:-}" =~ ^[Yy]$ ]]; then
    [[ ${EUID:-1000} -ne 0 ]] && SUDO_CMD="sudo" || SUDO_CMD=""
    log "Updating apt..."
    $SUDO_CMD apt-get update -y
    log "Installing packages: ffmpeg wget curl tar composer"
    $SUDO_CMD apt-get install -y ffmpeg wget curl tar composer
    log "ffmpeg has been installed successfully."
  else
    err "Operation cancelled. ffmpeg is required to continue."
    exit 1
  fi
else
  log "ffmpeg is already installed."
fi

WRAPPER="/var/www/pterodactyl/resources/views/templates/wrapper.blade.php"
BACKUP="$WRAPPER.bak"
MEDIA_DIR="/var/www/pterodactyl/public/assets/media"
CSS_DIR="/var/www/pterodactyl/public/assets/css"
mkdir -p "$MEDIA_DIR" "$CSS_DIR"

# Markers to keep edits safe + repeatable
HEAD_MARK_START="<!-- GHE_THEME_HEAD_START -->"
HEAD_MARK_END="<!-- GHE_THEME_HEAD_END -->"
VIDEO_MARK_START="<!-- GHE_THEME_VIDEO_START -->"
VIDEO_MARK_END="<!-- GHE_THEME_VIDEO_END -->"
FOOTER_MARK_START="<!-- GHE_THEME_FOOTER_START -->"
FOOTER_MARK_END="<!-- GHE_THEME_FOOTER_END -->"

echo
echo -e "${YELLOW}[1]${NC} Add custom background to the default theme"
echo -e "${YELLOW}[2]${NC} Install NookTheme and add custom background"
echo -e "${YELLOW}[3]${NC} Uninstall Theme and Restore Backup"
echo
read -p "Please choose an option [1-3]: " option

# --- Uninstall ---
if [[ "${option:-}" == "3" ]]; then
  log "Uninstall selected."

  if [[ -f "$BACKUP" ]]; then
    log "Restoring wrapper backup: $BACKUP"
    mv "$BACKUP" "$WRAPPER"
    log "Backup of wrapper.blade.php restored."
  else
    warn "No backup file found. Removing injected blocks only..."
    sed -i "/$HEAD_MARK_START/,/$HEAD_MARK_END/d" "$WRAPPER" || true
    sed -i "/$VIDEO_MARK_START/,/$VIDEO_MARK_END/d" "$WRAPPER" || true
    sed -i "/$FOOTER_MARK_START/,/$FOOTER_MARK_END/d" "$WRAPPER" || true
  fi

  log "Removing custom assets..."
  rm -f "$MEDIA_DIR/custom_bg."* || true
  rm -f "$CSS_DIR/custom-background.css" "$CSS_DIR/login-theme.css" || true

  log "Clearing Pterodactyl caches..."
  cd /var/www/pterodactyl
  php artisan view:clear || true
  php artisan config:clear || true
  php artisan cache:clear || true
  php artisan queue:restart || true

  log "Theme uninstalled and cache cleared successfully."
  exit 0
fi

# --- Get media URL ---
read -p "Enter the direct URL for the background media (image/video): " media_url
if [[ -z "${media_url:-}" ]]; then
  err "No URL was provided. Exiting."
  exit 1
fi

# Strip fragments/querystrings correctly
clean_url="${media_url%%\#*}"
clean_url="${clean_url%%\?*}"

file_extension="${clean_url##*.}"
file_extension="$(echo "$file_extension" | tr '[:upper:]' '[:lower:]')"

media_type="unknown"
case "$file_extension" in
  jpg|jpeg|png|gif) media_type="image" ;;
  mp4|webm|mov) media_type="video" ;;
  *)
    err "Unsupported file type '$file_extension'. Only jpg/png/gif and mp4/webm/mov are supported."
    exit 1
    ;;
esac

log "Media detected: $media_type ($file_extension)"

ORIGINAL_FILE="$MEDIA_DIR/original.$file_extension"
log "Downloading media to: $ORIGINAL_FILE"
wget -q --show-progress "$media_url" -O "$ORIGINAL_FILE"

# --- Convert / save media ---
if [[ "$media_type" == "video" ]]; then
  FINAL_FILE="$MEDIA_DIR/custom_bg.webm"
  log "Converting video to 1080p WebM (this can take time)..."
  log "FFmpeg progress will show below:"

  # NOTE: no trailing "\" with spaces — keep this clean
  ffmpeg -hide_banner -y -stats -loglevel warning -i "$ORIGINAL_FILE" \
    -vf "scale=-2:1080" -c:v libvpx-vp9 -crf 30 -b:v 0 -an \
    "$FINAL_FILE"

  if [[ -f "$FINAL_FILE" ]]; then
    log "Video conversion successful: $FINAL_FILE"
  else
    err "Video conversion failed. Please check the source file."
    rm -f "$ORIGINAL_FILE"
    exit 1
  fi

  rm -f "$ORIGINAL_FILE"
  saved_filename="custom_bg.webm"
else
  FINAL_FILE="$MEDIA_DIR/custom_bg.$file_extension"
  log "Saving image as: $FINAL_FILE"
  mv "$ORIGINAL_FILE" "$FINAL_FILE"
  saved_filename="custom_bg.$file_extension"
fi

# --- Generate CSS ---
log "Generating custom CSS..."
CSS_FILE="$CSS_DIR/custom-background.css"

if [[ "$media_type" == "image" ]]; then
cat <<EOF > "$CSS_FILE"
body {
  background: url('/assets/media/$saved_filename') no-repeat center center fixed !important;
  background-size: cover !important;
}
EOF
else
cat <<EOF > "$CSS_FILE"
#dynamic-background-video {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  z-index: -10;
  object-fit: cover;
  pointer-events: none;
}
body { background-color: #000 !important; }
EOF
fi

# --- Liquid Glass Login CSS (UPDATED: catches white card wrappers too) ---
log "Writing Liquid Glass login CSS (updated selectors)..."
LOGIN_CSS="$CSS_DIR/login-theme.css"
cat <<'EOF' > "$LOGIN_CSS"
/* =========================
   GHE Liquid Glass Login (Stronger selectors)
   ========================= */

/* Kill common solid backgrounds on login page wrappers */
.login-panel,
body[class*="LoginPageContainer"] .pt-8 > .w-full,
body[class*="LoginPageContainer"] .LoginPageContainer,
body[class*="LoginPageContainer"] .LoginFormContainer,
body[class*="LoginPageContainer"] .LoginFormContainer > div,
body[class*="LoginPageContainer"] .LoginFormContainer > div > div {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}

/* Common Tailwind "white card" classes used by themes */
body[class*="LoginPageContainer"] .bg-white,
body[class*="LoginPageContainer"] .bg-gray-50,
body[class*="LoginPageContainer"] .bg-neutral-50,
body[class*="LoginPageContainer"] .shadow,
body[class*="LoginPageContainer"] .shadow-sm,
body[class*="LoginPageContainer"] .shadow-md,
body[class*="LoginPageContainer"] .shadow-lg {
  background: transparent !important;
  box-shadow: none !important;
}

/* Apply glass to the form AND the typical wrapper div */
body[class*="LoginPageContainer"] form[action$="/login"],
body[class*="LoginPageContainer"] form[action$="/auth/login"],
body[class*="LoginPageContainer"] form[action*="login"],
body[class*="LoginPageContainer"] .LoginFormContainer > div {
  position: relative !important;
  overflow: hidden !important;
  border-radius: 22px !important;

  background: rgba(255, 255, 255, 0.08) !important;
  backdrop-filter: blur(18px) saturate(160%) !important;
  -webkit-backdrop-filter: blur(18px) saturate(160%) !important;

  border: 1px solid rgba(255, 255, 255, 0.22) !important;

  box-shadow:
    0 18px 50px rgba(0, 0, 0, 0.35),
    inset 0 1px 0 rgba(255, 255, 255, 0.20),
    inset 0 -1px 0 rgba(255, 255, 255, 0.06) !important;

  padding: 2.25rem !important;
}

/* Gloss highlight */
body[class*="LoginPageContainer"] form[action$="/login"]::before,
body[class*="LoginPageContainer"] form[action*="login"]::before,
body[class*="LoginPageContainer"] .LoginFormContainer > div::before {
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  border-radius: 22px;
  background:
    radial-gradient(120% 70% at 20% 0%, rgba(255,255,255,0.22) 0%, rgba(255,255,255,0.08) 35%, rgba(255,255,255,0.00) 65%),
    linear-gradient(180deg, rgba(255,255,255,0.10) 0%, rgba(255,255,255,0.00) 45%, rgba(0,0,0,0.10) 100%);
}

/* Subtle noise texture */
body[class*="LoginPageContainer"] form[action$="/login"]::after,
body[class*="LoginPageContainer"] form[action*="login"]::after,
body[class*="LoginPageContainer"] .LoginFormContainer > div::after {
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  border-radius: 22px;
  opacity: 0.08;
  mix-blend-mode: overlay;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
}

/* Logo */
body[class*="LoginPageContainer"] form img {
  display: block;
  margin-left: auto;
  margin-right: auto;
  margin-bottom: 1.25rem;
  filter: drop-shadow(0 8px 18px rgba(0,0,0,0.25));
}

/* Labels */
body[class*="LoginPageContainer"] label {
  color: rgba(255,255,255,0.90) !important;
  text-shadow: 0 1px 1px rgba(0,0,0,0.25);
}

/* Inputs */
body[class*="LoginPageContainer"] input[type=email],
body[class*="LoginPageContainer"] input[type=text],
body[class*="LoginPageContainer"] input[type=password] {
  background: rgba(0, 0, 0, 0.18) !important;
  border: 1px solid rgba(255, 255, 255, 0.22) !important;
  color: rgba(255,255,255,0.92) !important;
  border-radius: 14px !important;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.12), 0 10px 24px rgba(0,0,0,0.18);
}
body[class*="LoginPageContainer"] input::placeholder {
  color: rgba(255,255,255,0.55) !important;
}

/* Button */
body[class*="LoginPageContainer"] button[type=submit] {
  border-radius: 14px !important;
  background: rgba(13, 110, 253, 0.75) !important;
  border: 1px solid rgba(255,255,255,0.22) !important;
  color: white !important;
  box-shadow: 0 14px 30px rgba(13, 110, 253, 0.20), inset 0 1px 0 rgba(255,255,255,0.22);
  transition: transform 0.15s ease, background 0.2s ease, box-shadow 0.2s ease !important;
}
body[class*="LoginPageContainer"] button[type=submit]:hover {
  background: rgba(13, 110, 253, 0.85) !important;
}
body[class*="LoginPageContainer"] button[type=submit]:active {
  transform: translateY(1px);
}

/* Links */
body[class*="LoginPageContainer"] a {
  color: rgba(255,255,255,0.70) !important;
  text-align: center;
  display: block;
  margin-top: 1rem;
}
body[class*="LoginPageContainer"] a:hover {
  color: rgba(255,255,255,0.95) !important;
}

/* Mobile */
@media (max-width: 480px) {
  body[class*="LoginPageContainer"] .LoginFormContainer > div,
  body[class*="LoginPageContainer"] form[action*="login"] {
    padding: 1.5rem !important;
    border-radius: 18px !important;
  }
  body[class*="LoginPageContainer"] form[action*="login"]::before,
  body[class*="LoginPageContainer"] form[action*="login"]::after,
  body[class*="LoginPageContainer"] .LoginFormContainer > div::before,
  body[class*="LoginPageContainer"] .LoginFormContainer > div::after {
    border-radius: 18px;
  }
}
EOF

inject_wrapper() {
  log "Injecting code into wrapper (safe mode)..."

  [[ ! -f "$WRAPPER" ]] && { err "wrapper.blade.php not found at $WRAPPER"; exit 1; }
  [[ ! -f "$BACKUP" ]] && { log "Creating backup: $BACKUP"; cp "$WRAPPER" "$BACKUP"; }

  sed -i "/$HEAD_MARK_START/,/$HEAD_MARK_END/d" "$WRAPPER" || true
  sed -i "/$VIDEO_MARK_START/,/$VIDEO_MARK_END/d" "$WRAPPER" || true
  sed -i "/$FOOTER_MARK_START/,/$FOOTER_MARK_END/d" "$WRAPPER" || true

  if ! grep -q "</head>" "$WRAPPER"; then
    err "Could not find </head> in wrapper.blade.php. Aborting to prevent corruption."
    exit 1
  fi

  sed -i "s#</head>#$HEAD_MARK_START\n<link rel='stylesheet' href='/assets/css/custom-background.css'>\n<link rel='stylesheet' href='/assets/css/login-theme.css'>\n$HEAD_MARK_END\n</head>#i" "$WRAPPER"

  if [[ "$media_type" == "video" ]]; then
    VIDEO_TAG="<video autoplay muted loop playsinline id=\"dynamic-background-video\"><source src=\"/assets/media/$saved_filename\" type=\"video/webm\"></video>"

    if ! grep -Eq "<body[^>]*>" "$WRAPPER"; then
      err "Could not find a <body ...> tag in wrapper.blade.php. Aborting to prevent corruption."
      exit 1
    fi

    awk -v vstart="$VIDEO_MARK_START" -v vend="$VIDEO_MARK_END" -v vtag="$VIDEO_TAG" '
      BEGIN{done=0}
      {
        print
        if (!done && $0 ~ /<body[^>]*>/) {
          print vstart
          print vtag
          print vend
          done=1
        }
      }
    ' "$WRAPPER" > "$WRAPPER.tmp" && mv "$WRAPPER.tmp" "$WRAPPER"
  fi

  FOOTER_HTML="All rights reserved by Golden Hosting Enterprise © 2025 -2026"
  if grep -q "@yield('below-container')" "$WRAPPER"; then
    sed -i "/@yield('below-container')/a $FOOTER_MARK_START\n<div class=\"text-center text-xs text-neutral-500 mb-4\">${FOOTER_HTML}</div>\n$FOOTER_MARK_END" "$WRAPPER"
  else
    echo -e "\n$FOOTER_MARK_START\n<div class=\"text-center text-xs text-neutral-500 mb-4\">${FOOTER_HTML}</div>\n$FOOTER_MARK_END" >> "$WRAPPER"
  fi

  log "Wrapper injection done."
}

# --- Option 2: Install NookTheme ---
if [[ "${option:-}" == "2" ]]; then
  log "Installing NookTheme..."
  cd /var/www/pterodactyl
  php artisan down
  curl -L https://github.com/Nookure/NookTheme/releases/latest/download/panel.tar.gz | tar -xz
  chmod -R 755 storage/* bootstrap/cache
  composer install --no-dev --optimize-autoloader
  php artisan migrate --seed --force
  php artisan view:clear
  php artisan config:clear
  php artisan queue:restart
  php artisan up
  chown -R www-data:www-data .
  log "NookTheme installation completed."
fi

inject_wrapper

log "Setting permissions on assets..."
chown -R www-data:www-data /var/www/pterodactyl/public/assets

log "Clearing caches and restarting queue..."
cd /var/www/pterodactyl
php artisan view:clear
php artisan config:clear
php artisan cache:clear
php artisan queue:restart

echo
echo -e "${GREEN}雪 Theme deployment complete.${NC}"
log "Done."
