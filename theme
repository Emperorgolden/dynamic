#!/bin/bash
set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

LOG_FILE="/var/log/ghe-theme-deployer.log"

# --- Logging helpers ---
log()  { echo -e "${CYAN}[INFO]${NC}  $*"; }
warn() { echo -e "${YELLOW}[WARN]${NC}  $*"; }
err()  { echo -e "${RED}[ERROR]${NC} $*"; }

# Log everything to console + file
mkdir -p "$(dirname "$LOG_FILE")" || true
exec > >(tee -a "$LOG_FILE") 2>&1

# Helpful error if anything fails
trap 'err "Script failed at line $LINENO. Check log: $LOG_FILE"' ERR

clear
echo -e "${CYAN}=============================================="
echo -e " Golden Hosting Enterprise - Theme Deployer v2"
echo -e "==============================================${NC}"
echo
log "Logging to: $LOG_FILE"

# --- Paths ---
PANEL_DIR="/var/www/pterodactyl"
WRAPPER="$PANEL_DIR/resources/views/templates/wrapper.blade.php"
BACKUP="$WRAPPER.bak"
MEDIA_DIR="$PANEL_DIR/public/assets/media"
CSS_DIR="$PANEL_DIR/public/assets/css"
LOGIN_FORM="$PANEL_DIR/resources/scripts/components/auth/LoginFormContainer.tsx"
LOGIN_FORM_BACKUP="$LOGIN_FORM.bak"

mkdir -p "$MEDIA_DIR" "$CSS_DIR"

# Markers to keep edits safe + repeatable
HEAD_MARK_START="<!-- GHE_THEME_HEAD_START -->"
HEAD_MARK_END="<!-- GHE_THEME_HEAD_END -->"
VIDEO_MARK_START="<!-- GHE_THEME_VIDEO_START -->"
VIDEO_MARK_END="<!-- GHE_THEME_VIDEO_END -->"
FOOTER_MARK_START="<!-- GHE_THEME_FOOTER_START -->"
FOOTER_MARK_END="<!-- GHE_THEME_FOOTER_END -->"

# --- Dependencies ---
if ! command -v ffmpeg &>/dev/null; then
  warn "ffmpeg is not installed."
  read -p "Do you want to install it now? (y/N): " install_ffmpeg
  if [[ "${install_ffmpeg:-}" =~ ^[Yy]$ ]]; then
    [[ ${EUID:-1000} -ne 0 ]] && SUDO_CMD="sudo" || SUDO_CMD=""
    log "Updating apt..."
    $SUDO_CMD apt-get update -y
    log "Installing packages: ffmpeg wget curl tar composer"
    $SUDO_CMD apt-get install -y ffmpeg wget curl tar composer
    log "ffmpeg has been installed successfully."
  else
    err "Operation cancelled. ffmpeg is required to continue."
    exit 1
  fi
else
  log "ffmpeg is already installed."
fi

if ! command -v wget &>/dev/null; then
  err "wget not found. Install it: apt-get install -y wget"
  exit 1
fi

echo
echo -e "${YELLOW}[1]${NC} Add custom background to the default theme"
echo -e "${YELLOW}[2]${NC} Install NookTheme and add custom background"
echo -e "${YELLOW}[3]${NC} Uninstall Theme and Restore Backup"
echo
read -p "Please choose an option [1-3]: " option

# --- Uninstall ---
if [[ "${option:-}" == "3" ]]; then
  log "Uninstall selected."

  if [[ -f "$BACKUP" ]]; then
    log "Restoring wrapper backup: $BACKUP"
    mv "$BACKUP" "$WRAPPER"
    log "Wrapper backup restored."
  else
    warn "No wrapper backup file found. Removing injected blocks only..."
    sed -i "/$HEAD_MARK_START/,/$HEAD_MARK_END/d" "$WRAPPER" || true
    sed -i "/$VIDEO_MARK_START/,/$VIDEO_MARK_END/d" "$WRAPPER" || true
    sed -i "/$FOOTER_MARK_START/,/$FOOTER_MARK_END/d" "$WRAPPER" || true
  fi

  if [[ -f "$LOGIN_FORM_BACKUP" ]]; then
    log "Restoring LoginFormContainer.tsx backup: $LOGIN_FORM_BACKUP"
    mv "$LOGIN_FORM_BACKUP" "$LOGIN_FORM"
    log "LoginFormContainer.tsx restored."
  else
    warn "No LoginFormContainer.tsx backup found. Leaving current version in place."
  fi

  log "Removing custom assets..."
  rm -f "$MEDIA_DIR/custom_bg."* || true
  rm -f "$CSS_DIR/custom-background.css" "$CSS_DIR/login-theme.css" || true

  log "Clearing Pterodactyl caches..."
  cd "$PANEL_DIR"
  php artisan view:clear || true
  php artisan config:clear || true
  php artisan cache:clear || true
  php artisan queue:restart || true

  log "Theme uninstalled and cache cleared successfully."
  exit 0
fi

# --- Get media URL ---
read -p "Enter the direct URL for the background media (image/video): " media_url
if [[ -z "${media_url:-}" ]]; then
  err "No URL was provided. Exiting."
  exit 1
fi

# Strip fragments/querystrings correctly
clean_url="${media_url%%\#*}"
clean_url="${clean_url%%\?*}"

file_extension="${clean_url##*.}"
file_extension="$(echo "$file_extension" | tr '[:upper:]' '[:lower:]')"

media_type="unknown"
case "$file_extension" in
  jpg|jpeg|png|gif) media_type="image" ;;
  mp4|webm|mov) media_type="video" ;;
  *)
    err "Unsupported file type '$file_extension'. Only jpg/png/gif and mp4/webm/mov are supported."
    exit 1
    ;;
esac

log "Media detected: $media_type ($file_extension)"

ORIGINAL_FILE="$MEDIA_DIR/original.$file_extension"
log "Downloading media to: $ORIGINAL_FILE"
wget -q --show-progress "$media_url" -O "$ORIGINAL_FILE"

# --- Convert / save media ---
if [[ "$media_type" == "video" ]]; then
  FINAL_FILE="$MEDIA_DIR/custom_bg.webm"
  log "Converting video to 1080p WebM (this can take time)..."
  log "FFmpeg progress will show below:"

  ffmpeg -hide_banner -y -stats -loglevel warning -i "$ORIGINAL_FILE" \
    -vf "scale=-2:1080" -c:v libvpx-vp9 -crf 30 -b:v 0 -an \
    "$FINAL_FILE"

  if [[ -f "$FINAL_FILE" ]]; then
    log "Video conversion successful: $FINAL_FILE"
  else
    err "Video conversion failed. Please check the source file."
    rm -f "$ORIGINAL_FILE" || true
    exit 1
  fi

  rm -f "$ORIGINAL_FILE" || true
  saved_filename="custom_bg.webm"
else
  FINAL_FILE="$MEDIA_DIR/custom_bg.$file_extension"
  log "Saving image as: $FINAL_FILE"
  mv "$ORIGINAL_FILE" "$FINAL_FILE"
  saved_filename="custom_bg.$file_extension"
fi

# --- Generate CSS for background ---
log "Generating custom background CSS..."
CSS_FILE="$CSS_DIR/custom-background.css"

if [[ "$media_type" == "image" ]]; then
cat <<EOF > "$CSS_FILE"
body {
  background: url('/assets/media/$saved_filename') no-repeat center center fixed !important;
  background-size: cover !important;
}
EOF
else
cat <<EOF > "$CSS_FILE"
#dynamic-background-video {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  z-index: -10;
  object-fit: cover;
  pointer-events: none;
}
body { background-color: #000 !important; }
EOF
fi

# --- Liquid Glass Login CSS (same as your current one) ---
log "Writing Liquid Glass login CSS..."
LOGIN_CSS="$CSS_DIR/login-theme.css"
cat <<'EOF' > "$LOGIN_CSS"
/* =========================
   GHE Liquid Glass Login (Default + NookTheme)
   Goal: remove white card + remove blue solid button + glass inputs/buttons
   ========================= */

/* Make page wrappers transparent (kills extra white backgrounds) */
.login-panel,
.LoginFormContainer,
.LoginPageContainer,
body[class*="LoginPageContainer"] .pt-8 > .w-full,
body[class*="LoginPageContainer"] .w-full,
body[class*="LoginPageContainer"] .mx-auto,
body[class*="LoginPageContainer"] .shadow,
body[class*="LoginPageContainer"] [class*="shadow"],
body[class*="LoginPageContainer"] .bg-white,
body[class*="LoginPageContainer"] [class*="bg-white"],
body:has(form[action*="login"]) .bg-white,
body:has(form[action*="login"]) [class*="bg-white"] {
  background: transparent !important;
  box-shadow: none !important;
  border: none !important;
}

/* KEY: make the actual “card wrapper” glass (NookTheme often uses a wrapper div around the form) */
:where(.bg-white, [class*="bg-white"], [class*="bg-gray"], [class*="dark:bg"], .shadow, [class*="shadow"]):has(form[action*="login"]) {
  position: relative !important;
  overflow: hidden !important;
  border-radius: 22px !important;

  background: rgba(255, 255, 255, 0.10) !important;
  backdrop-filter: blur(18px) saturate(160%) !important;
  -webkit-backdrop-filter: blur(18px) saturate(160%) !important;

  border: 1px solid rgba(255, 255, 255, 0.22) !important;

  box-shadow:
    0 18px 50px rgba(0, 0, 0, 0.35),
    inset 0 1px 0 rgba(255, 255, 255, 0.20),
    inset 0 -1px 0 rgba(255, 255, 255, 0.06) !important;
}

/* Gloss highlight */
:where(.bg-white, [class*="bg-white"], [class*="bg-gray"], [class*="dark:bg"], .shadow, [class*="shadow"]):has(form[action*="login"])::before {
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  border-radius: 22px;
  background:
    radial-gradient(120% 70% at 20% 0%, rgba(255,255,255,0.22) 0%, rgba(255,255,255,0.08) 35%, rgba(255,255,255,0.00) 65%),
    linear-gradient(180deg, rgba(255,255,255,0.10) 0%, rgba(255,255,255,0.00) 45%, rgba(0,0,0,0.10) 100%);
}

/* Noise texture */
:where(.bg-white, [class*="bg-white"], [class*="bg-gray"], [class*="dark:bg"], .shadow, [class*="shadow"]):has(form[action*="login"])::after {
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  border-radius: 22px;
  opacity: 0.08;
  mix-blend-mode: overlay;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
}

/* Make the form itself transparent so the wrapper glass is visible */
:where(form[action*="login"], form[action$="/login"], form[action$="/auth/login"]) {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}

/* -------------------------
   Inputs glass
   ------------------------- */
body:has(form[action*="login"]) input,
body:has(form[action*="login"]) textarea,
body:has(form[action*="login"]) select {
  background: rgba(255, 255, 255, 0.12) !important;
  backdrop-filter: blur(14px) !important;
  -webkit-backdrop-filter: blur(14px) !important;

  border: 1px solid rgba(255, 255, 255, 0.28) !important;
  color: rgba(255,255,255,0.95) !important;

  border-radius: 14px !important;

  box-shadow:
    inset 0 1px 0 rgba(255,255,255,0.25),
    0 8px 24px rgba(0,0,0,0.25) !important;
}

body:has(form[action*="login"]) input::placeholder {
  color: rgba(255,255,255,0.60) !important;
}

/* -------------------------
   Button glass
   ------------------------- */
body:has(form[action*="login"]) button,
body:has(form[action*="login"]) button[type="submit"],
body:has(form[action*="login"]) button[class*="bg"],
body:has(form[action*="login"]) button[class*="primary"],
body:has(form[action*="login"]) button[class*="blue"],
body:has(form[action*="login"]) button[class*="indigo"] {
  background: rgba(255, 255, 255, 0.18) !important;
  backdrop-filter: blur(16px) saturate(160%) !important;
  -webkit-backdrop-filter: blur(16px) saturate(160%) !important;

  border: 1px solid rgba(255, 255, 255, 0.35) !important;
  color: #fff !important;

  border-radius: 14px !important;

  box-shadow:
    0 12px 30px rgba(0,0,0,0.35),
    inset 0 1px 0 rgba(255,255,255,0.35) !important;

  transition: all 0.2s ease !important;
}

body:has(form[action*="login"]) button:hover {
  background: rgba(255, 255, 255, 0.28) !important;
  transform: translateY(-1px);
}

body:has(form[action*="login"]) button:active {
  transform: translateY(0);
}

/* Labels/links */
body:has(form[action*="login"]) label { color: rgba(255,255,255,0.90) !important; }
body:has(form[action*="login"]) a { color: rgba(255,255,255,0.75) !important; }
body:has(form[action*="login"]) a:hover { color: rgba(255,255,255,0.95) !important; }

/* Mobile */
@media (max-width: 480px) {
  :where(.bg-white, [class*="bg-white"], [class*="bg-gray"], [class*="dark:bg"], .shadow, [class*="shadow"]):has(form[action*="login"]) {
    border-radius: 18px !important;
  }
  :where(.bg-white, [class*="bg-white"], [class*="bg-gray"], [class*="dark:bg"], .shadow, [class*="shadow"]):has(form[action*="login"])::before,
  :where(.bg-white, [class*="bg-white"], [class*="bg-gray"], [class*="dark:bg"], .shadow, [class*="shadow"]):has(form[action*="login"])::after {
    border-radius: 18px !important;
  }
}
EOF

# --- Function: update LoginFormContainer.tsx with your glass build ---
update_login_form_tsx() {
  log "Updating LoginFormContainer.tsx to glossy glass version..."

  if [[ ! -f "$LOGIN_FORM" ]]; then
    err "LoginFormContainer.tsx not found at $LOGIN_FORM"
    return
  fi

  if [[ ! -f "$LOGIN_FORM_BACKUP" ]]; then
    log "Creating backup of LoginFormContainer.tsx at $LOGIN_FORM_BACKUP"
    cp "$LOGIN_FORM" "$LOGIN_FORM_BACKUP"
  else
    log "Backup of LoginFormContainer.tsx already exists, not overwriting."
  fi

  cat <<'EOF' > "$LOGIN_FORM"
import React, { forwardRef } from 'react';
import { Form } from 'formik';
import styled from 'styled-components/macro';
import { breakpoint } from '@/theme';
import FlashMessageRender from '@/components/FlashMessageRender';
import tw from 'twin.macro';

type Props = React.DetailedHTMLProps<React.FormHTMLAttributes<HTMLFormElement>, HTMLFormElement> & {
    title?: string;
};

const Container = styled.div`
    ${breakpoint('sm')`
        ${tw`w-4/5 mx-auto`}
    `};

    ${breakpoint('md')`
        ${tw`p-10`}
    `};

    ${breakpoint('lg')`
        ${tw`w-3/5`}
    `};

    ${breakpoint('xl')`
        ${tw`w-full`}
        max-width: 700px;
    `};
`;

export default forwardRef<HTMLFormElement, Props>(({ title, ...props }, ref) => (
    <Container>
        {title && (
            <h2 css={tw`text-3xl text-center text-neutral-100 font-medium py-4`}>
                {title}
            </h2>
        )}

        <FlashMessageRender css={tw`mb-2 px-1`} />

        <Form {...props} ref={ref}>
            <div
                css={tw`
                    md:flex w-full
                    p-6 md:pl-0 mx-1
                    rounded-2xl
                    bg-white/10
                    backdrop-blur-lg
                    border border-white/30
                    shadow-2xl
                    relative overflow-hidden
                `}
                className="glass-wrapper"
            >
                {/* Shine Layer */}
                <div
                    css={tw`absolute inset-0 pointer-events-none rounded-2xl`}
                    style={{
                        background: `
                            radial-gradient(120% 70% at 20% 0%, rgba(255,255,255,0.22) 0%, rgba(255,255,255,0.08) 35%, rgba(255,255,255,0.00) 65%),
                            linear-gradient(180deg, rgba(255,255,255,0.10) 0%, rgba(255,255,255,0.00) 45%, rgba(0,0,0,0.10) 100%)`,
                    }}
                />
                {/* Noise Texture Layer */}
                <div
                    css={tw`absolute inset-0 pointer-events-none rounded-2xl opacity-10 mix-blend-overlay`}
                    style={{
                        backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E")`,
                    }}
                />

                <div css={tw`flex-none select-none mb-6 md:mb-0 self-center z-10`}>
                    <img
                        src={'/assets/svgs/pterodactyl.svg'}
                        css={tw`block w-48 md:w-64 mx-auto`}
                    />
                </div>

                <div css={tw`flex-1 z-10`}>
                    {props.children}
                </div>
            </div>
        </Form>

        <p css={tw`text-center text-neutral-500 text-xs mt-4`}>
            &copy; 2025 - {new Date().getFullYear()}&nbsp;
            <a
                rel={'noopener nofollow noreferrer'}
                href={'https://pterodactyl.io'}
                target={'_blank'}
                css={tw`no-underline text-neutral-500 hover:text-neutral-300`}
            >
                Pterodactyl Software
            </a>
            &nbsp;•&nbsp;All rights reserved by Golden Hosting Enterprise
        </p>
    </Container>
));
EOF

  log "LoginFormContainer.tsx updated."
}

inject_wrapper() {
  log "Injecting code into wrapper (safe mode)..."

  [[ ! -f "$WRAPPER" ]] && { err "wrapper.blade.php not found at $WRAPPER"; exit 1; }
  [[ ! -f "$BACKUP" ]] && { log "Creating backup: $BACKUP"; cp "$WRAPPER" "$BACKUP"; }

  # Remove old injected blocks (idempotent)
  sed -i "/$HEAD_MARK_START/,/$HEAD_MARK_END/d" "$WRAPPER" || true
  sed -i "/$VIDEO_MARK_START/,/$VIDEO_MARK_END/d" "$WRAPPER" || true
  sed -i "/$FOOTER_MARK_START/,/$FOOTER_MARK_END/d" "$WRAPPER" || true

  if ! grep -q "</head>" "$WRAPPER"; then
    err "Could not find </head> in wrapper.blade.php. Aborting to prevent corruption."
    exit 1
  fi

  # Inject CSS links right before </head>
  sed -i "s#</head>#$HEAD_MARK_START\n<link rel='stylesheet' href='/assets/css/custom-background.css'>\n<link rel='stylesheet' href='/assets/css/login-theme.css'>\n$HEAD_MARK_END\n</head>#i" "$WRAPPER"

  # Inject video right after <body ...>
  if [[ "$media_type" == "video" ]]; then
    VIDEO_TAG="<video autoplay muted loop playsinline id=\"dynamic-background-video\"><source src=\"/assets/media/$saved_filename\" type=\"video/webm\"></video>"

    if ! grep -Eq "<body[^>]*>" "$WRAPPER"; then
      err "Could not find a <body ...> tag in wrapper.blade.php. Aborting to prevent corruption."
      exit 1
    fi

    awk -v vstart="$VIDEO_MARK_START" -v vend="$VIDEO_MARK_END" -v vtag="$VIDEO_TAG" '
      BEGIN{done=0}
      {
        print
        if (!done && $0 ~ /<body[^>]*>/) {
          print vstart
          print vtag
          print vend
          done=1
        }
      }
    ' "$WRAPPER" > "$WRAPPER.tmp" && mv "$WRAPPER.tmp" "$WRAPPER"
  fi

  # Footer (KEEP THIS)
  FOOTER_HTML="All rights reserved by Golden Hosting Enterprise © 2025 -2026"
  if grep -q "@yield('below-container')" "$WRAPPER"; then
    sed -i "/@yield('below-container')/a $FOOTER_MARK_START\n<div class=\"text-center text-xs text-neutral-500 mb-4\">${FOOTER_HTML}</div>\n$FOOTER_MARK_END" "$WRAPPER"
  else
    echo -e "\n$FOOTER_MARK_START\n<div class=\"text-center text-xs text-neutral-500 mb-4\">${FOOTER_HTML}</div>\n$FOOTER_MARK_END" >> "$WRAPPER"
  fi

  log "Wrapper injection done."
}

# --- Option 2: Install NookTheme ---
if [[ "${option:-}" == "2" ]]; then
  log "Installing NookTheme..."
  cd "$PANEL_DIR"

  php artisan down

  log "Downloading + extracting NookTheme..."
  curl -L https://github.com/Nookure/NookTheme/releases/latest/download/panel.tar.gz | tar -xz

  log "Fixing permissions..."
  chmod -R 755 storage/* bootstrap/cache

  # Avoid interactive composer prompt
  export COMPOSER_ALLOW_SUPERUSER=1

  log "Running composer install..."
  composer install --no-dev --optimize-autoloader --no-interaction

  log "Running migrations + seed..."
  php artisan migrate --seed --force

  log "Clearing config/view cache + restarting queue..."
  php artisan view:clear
  php artisan config:clear
  php artisan queue:restart

  php artisan up
  chown -R www-data:www-data .

  log "NookTheme installation completed."
fi

# Apply your React glass container (for both option 1 and 2)
update_login_form_tsx

# Inject wrapper changes + CSS/video
inject_wrapper

log "Setting permissions on assets..."
chown -R www-data:www-data "$PANEL_DIR/public/assets"

log "Clearing caches and restarting queue..."
cd "$PANEL_DIR"
php artisan view:clear
php artisan config:clear
php artisan cache:clear
php artisan queue:restart

echo
echo -e "${GREEN}雪 Theme deployment complete.${NC}"
log "Done."
